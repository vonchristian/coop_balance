
<div class="row">
  <div class="col-md-7">
    <div class="card">
      <div class="card-header">
        <center>
          <%= image_tag(@loan_application.avatar.variant(resize: '60x60'), class: "img-circle") if @loan_application.avatar.attached? %><br>
          <h3 class="card-title"> <%= @loan_application.borrower_name %> </h3>
        </center>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h3 class="card-title">Loan Amount </h3>
          </div>
          <div class="col-md-3">
            <h3 class="card-title float-right"><%= number_to_currency @loan_application.loan_amount %></h3>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-md-8">
            <h4 class="card-title text-danger"> Loan Charges </h4>
            <br>
          </div>
          <div class="col-md-3">
            <%= link_to new_loans_module_loan_application_voucher_amount_path(@loan_application), data: { modal: true } do %>
              <span class="btn btn-outline-danger btn-sm float-right" data-toggle="tooltip" title="Add Charges">
                <i class="fa fa-plus-circle"></i> Add
              </span>
            <% end %>
          </div>
        </div>
        <hr class="min-margin">
        <% @loan_application.voucher_amounts.each do |voucher_amount| %>
          <div class="row justify-content-end">
            <div class="col-md-11">
              <div class="row">
                <div class="col-md-6">
                  <%= voucher_amount.description %>
                </div>
                <div class="col-md-2">
                  <%= link_to new_loans_module_voucher_amount_amount_adjustment_path(voucher_amount_id: voucher_amount.id, loan_application_id: @loan_application.id), data: { modal: true } do %>
                    <span data-toggle="tooltip" title="Adjust"><i class="fa fa-edit"></i>
                    </span>
                  <% end %>
                  &nbsp;
                  <%= link_to loans_module_loan_application_voucher_amount_path(id: voucher_amount.id, voucher_amount_id: voucher_amount.id, loan_application_id: @loan_application.id), method: :delete do %>
                    <span data-toggle="tooltip" title="Remove"><i class="fa fa-times text-danger"></i>
                    </span>
                  <% end %>
                </div>
                <div class="col-md-3">
                  <span class="float-right">
                    <%= number_to_currency voucher_amount.adjusted_amount %>
                  </span>
                </div>
              </div>
              <div class="min-margin">
              </div>
            </div>
          </div>
        <% end %>
        <hr>
        <div class="row">
          <div class="col-md-8">
            <h3 class="card-title"> Net Proceed </h3>
          </div>
          <div class="col-md-3">
            <h3 class="card-title float-right"><%= number_to_currency @loan_application.net_proceed %></h3>
          </div>
        </div>
      </div>
      <hr class="no-margin">
      <div class="card-body">
        <%= simple_form_for [@loan_application, @voucher], url: :loans_module_loan_application_vouchers, html: { autocomplete: 'off' } do |f| %>
          <%= f.input :date, as: :string, input_html: { class: "datepicker", value: Date.today.strftime("%B %e, %Y") } %>
          <%= f.input :description, input_html: { value: "#{@loan_application.loan_product_name} disbursement voucher of #{@loan_application.borrower_name}" }, as: :text %>
          <%= f.input :number, input_html: { value: Voucher.generate_number_for(@voucher) } %>
          <%= f.input :preparer_id, input_html: { value: current_user.id }, as: :hidden %>

          <%= f.input :borrower_id, input_html: { value: @loan_application.borrower_id }, as: :hidden %>
          <%= f.input :borrower_type, input_html: { value: @loan_application.borrower.class.to_s }, as: :hidden %>
          <%= f.input :net_proceed, input_html: { value: @loan_application.net_proceed.round(2) }, as: :hidden %>

          <%= f.input :loan_application_id, input_html: { value: @loan_application.id }, as: :hidden %>
          <%= f.input :account_number, input_html: { value: SecureRandom.uuid }, as: :hidden %>
          <%= f.input :voucher_account_number, input_html: { value: SecureRandom.uuid }, as: :hidden %>
          <%= f.input :cash_account_id, collection: Employees::EmployeeCashAccount.cash_accounts.map{|a| [a.name, a.id] } %>
          <hr>
          <%= f.submit "Create Voucher", class: "btn btn-primary btn-lg float-right" %>
          <%= link_to 'Cancel Application', loans_module_loan_application_path(@loan_application), method: :delete, class: "btn float-left text-danger" %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card">
      <div class="card-header with-border">
        <h3 class="card-title"> Share Capital </h3>
      </div>
      <div class="card-body">
        <% @share_capitals.each do |share_capital| %>
          <div class="row">
            <div class="col-md-2">
              <% if share_capital.subscriber.avatar.attachment.present? %>
                <%= image_tag(share_capital.subscriber.avatar, style: 'width:40px;height:40px;', class: 'media-object img-circle') %>
              <% end %>
            </div>
            <div class="col-md-6">
              <h3 class="card-title"><%= number_to_currency share_capital.paid_up_balance %></h3>
              <span class="text-muted"><%= share_capital.subscriber_name %></span><br>
              <% if @loan_application.voucher_amounts.for_account(account: share_capital.share_capital_product_paid_up_account).present? %>
                <span class="text-success"> <i class="fa fa-plus"></i>
                <%= number_to_currency @loan_application.voucher_amounts.for_account(account: share_capital.share_capital_product_paid_up_account).where(commercial_document: share_capital).total %>
                </span>
              <% end %>
            </div>
            <div class="col-md-3">
               <%=link_to new_loans_module_loan_application_capital_build_up_processing_path(share_capital_id: share_capital.id, loan_application_id: @loan_application.id) do %>
                 <span class="btn btn-outline-warning float-right"><i class="fa fa-plus-circle"></i> Add </span>
               <% end %>
            </div>
          </div>
          <hr>
        <% end %>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"> Savings Accounts </h3>
      </div>
      <div class="card-body">
        <% @savings_accounts.each do |savings_account| %>
          <div class="row">
            <div class="col-md-2">
              <% if savings_account.depositor.avatar.attachment.present? %>
                <%= image_tag(savings_account.depositor.avatar, style: 'width:40px;height:40px;', class: 'media-object img-circle') %>
              <% end %>
            </div>
            <div class="col-md-7">
              <h3 class="card-title">
                <%= number_to_currency savings_account.balance %>
              </h3>
                <span class="text-muted">
                  <%= savings_account.depositor_name %>
                </span>
              <br>
              <% if @loan_application.voucher_amounts.for_account(account: savings_account.saving_product_account).present? %>
                <span class="text-success"> <i class="fa fa-plus"></i>
                <%= number_to_currency @loan_application.voucher_amounts.for_account(account: savings_account.saving_product_account).where(commercial_document: savings_account).total %>
                </span>
              <% end %>

            </div>
            <div class="col-md-2">
              <%=link_to new_loans_module_loan_application_savings_account_deposit_processing_path(saving_id: savings_account.id, loan_application_id: @loan_application.id) do %>
                 <span class="btn btn-outline-warning float-right"><i class="fa fa-plus-circle"></i> Add </span>
               <% end %>
            </div>
          </div>
          <hr>
        <% end %>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"> Amortization Schedules </h3>
      </div>
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th> Date </th>
              <th> Principal </th>
              <th> Interest </th>
              <th> Total </th>
              <th> Loan Balance </th>
            </tr>
          </thead>
          <tbody>
            <% @loan_application.amortization_schedules.order(date: :asc).each do |amortization_schedule| %>
              <tr>
                <td><%= amortization_schedule.date.strftime("%B %e, %Y") %></td>
                <td><%= number_to_currency amortization_schedule.principal %></td>
                <td><%= number_to_currency amortization_schedule.interest %></td>
                <td><%= number_to_currency amortization_schedule.total_amortization %></td>
                <td><%= number_to_currency @loan_application.balance_for(amortization_schedule) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
